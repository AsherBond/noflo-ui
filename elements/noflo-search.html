<link rel="import" href="noflo-menu.html">
<link rel="import" href="noflo-search-results.html">
<polymer-element name="noflo-search" attributes="buttons results project graph component">
  <style>
    noflo-search.overlay #breadcrumb {
      width: calc(72px * 4);
    }
    noflo-search #breadcrumb {
      position: relative;
      overflow: hidden;
      width: 0px;
      height: 72px;
      left: 0px;
      top: 0px;
      z-index: 1;
      background-color: hsl(187, 45%, 5%);
      transition: width 0.3s ease-in-out;
    }
    noflo-search #breadcrumb i {
      position: absolute;
      line-height: 72px;
      left: 18px;
      font-size: 21px;
      color: hsl(189, 11%, 26%);
    }
    noflo-search #breadcrumb h2 {
      display: inline-block;
      line-height: 72px;
      margin: 0px;
      padding: 0px;
      box-sizing: border-box;
      padding-left: 48px;
      color: hsl(189, 11%, 26%);
      font-size: 10px;
      font-weight: normal;
      text-transform: uppercase;
      width: 126px;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    noflo-search #breadcrumb h2:after {
      content: ' //';
      display: inline;
    }
    noflo-search #breadcrumb h1 {
      display: inline-block;
      line-height: 72px;
      margin: 0px;
      padding: 0px;
      overflow: hidden;
      text-overflow: ellipsis;
      width: 158px;
      font-weight: normal;
    }
    noflo-search #search {
      position: absolute;
      top: 0px;
      left: 0px;
      background-color: hsl(187, 45%, 5%);
      font-family: "SourceCodePro",Helvetica,Arial,sans-serif;
      border: none;
      padding: 0px;
      padding-right: 18px;
      padding-left: 18px;
      color: white;
      width: 288px;
      height: 72px;
      box-sizing: border-box;
      font-size: 16px;
      display: inline;
    }
  </style>
  <template>
    <div id="breadcrumb" on-click="{{ focus }}">
      <i class="fa fa-search"></i>
      <template if="{{ project }}">
      <h2>{{ project.name }}</h2>
      </template>
      <template if="{{ graph && !project }}">
      <h2>Sketch</h2>
      </template>
      <template if="{{ graph }}">
      <h1>{{ graph.properties.name }}</h1>
      </template>
      <template if="{{ component }}">
      <h1>{{ component.name }}</h1>
      </template>
    </div>
    <input id="search" value="{{ search }}" type="text" placeholder="Search" x-webkit-speech>
  </template>
  <script>
    Polymer('noflo-search', {
      menuCard: null,
      resultsCard: null,
      buttons: [],
      results: [],
      search: '',
      project: null,
      graph: null,
      component: null,
      enteredView: function () {
        this.contextBar = document.getElementById('context');
        this.observer = new ArrayObserver(this.results, this.resultsModified.bind(this));
        this.blur();
      },
      focus: function () {
        this.classList.remove('overlay');
        this.$.search.focus();
      },
      blur: function () {
        this.classList.add('overlay');
      },
      searchChanged: function () {
        event.preventDefault();
        if (this.search === '') {
          this.blur();
          if (this.resultsCard) {
            this.resultsCard.parentNode.removeChild(this.resultsCard);
            this.resultsCard = null;
          }
          this.fire('search', this.search);
          return;
        }
        while (this.results.length) {
          this.results.pop();
        }
        if (this.resultsCard) {
          this.resultsCard.getElementsByTagName('noflo-search-results')[0].search = this.search;
        }
        this.fire('search', this.search);
      },
      resultsModified: function () {
        if (this.resultsCard || this.search === '') {
          return;
        }
        if (this.results.length === 0) {
          if (this.resultsCard) {
            this.resultsCard.parentNode.removeChild(this.resultsCard);
            this.resultsCard = null;
          }
          return;
        }
        var results = document.createElement('noflo-search-results');
        results.results = this.results;
        results.search = this.search;
        results.addEventListener('resultclick', function () {
          this.search = '';
        }.bind(this));

        this.resultsCard = document.createElement('the-card');
        this.resultsCard.type = 'noflo-search-results';
        this.resultsCard.appendChild(results);
        this.resultsCard.addTo(this.contextBar, true);
      }
    });
  </script>
</polymer-element>
